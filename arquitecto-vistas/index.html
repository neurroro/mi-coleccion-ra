<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Arquitecto de Vistas - TUTOR IA FUNCIONAL</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- Estilos -->
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { 
            width: 100vw; 
            height: 100vh; 
            overflow: hidden;
            font-family: 'Segoe UI', Arial, sans-serif;
        }
        
        #conceptual, #conceptualizacion, #resultados {
            position: fixed; 
            width: 100%; 
            height: 100%;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
            color: white;
            display: flex; 
            flex-direction: column;
            align-items: center;
            text-align: center; 
            padding: 20px;
            z-index: 1000;
            overflow-y: auto;
            top: 0;
            left: 0;
        }
        
        #conceptualizacion {
            display: none;
            padding: 30px 20px;
            justify-content: flex-start;
        }
        
        #resultados { 
            display: none; 
            padding: 40px 20px;
            justify-content: flex-start;
            padding-top: 60px;
        }
        
        .btn {
            background: linear-gradient(45deg, #007AFF, #00BCD4);
            color: white;
            border: none;
            padding: 15px 30px;
            margin: 10px;
            border-radius: 15px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            width: 90%;
            max-width: 300px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 122, 255, 0.3);
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 122, 255, 0.4);
        }
        
        #barra-superior {
            position: fixed;
            top: 0; left: 0;
            width: 100%;
            height: 60px;
            background: linear-gradient(90deg, rgba(0,0,0,0.95) 0%, rgba(26,26,46,0.95) 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            z-index: 900;
            border-bottom: 2px solid #00BCD4;
            backdrop-filter: blur(5px);
        }
        
        #panel-ia {
            position: fixed;
            bottom: 0; left: 0;
            width: 100%;
            background: rgba(0,0,0,0.95);
            color: white;
            padding: 20px;
            z-index: 900;
            text-align: center;
            max-height: 40vh;
            overflow-y: auto;
            border-top: 2px solid #00BCD4;
            backdrop-filter: blur(5px);
        }
        
        .opcion-btn {
            background: linear-gradient(45deg, #00BCD4, #0097A7);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 12px;
            cursor: pointer;
            width: 100%;
            max-width: 350px;
            margin: 8px 0;
            transition: all 0.3s ease;
            font-size: 15px;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0, 188, 212, 0.3);
        }
        
        .opcion-btn:hover {
            background: linear-gradient(45deg, #0097A7, #00838F);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 188, 212, 0.4);
        }
        
        .opcion-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        #indicador-ar {
            position: fixed;
            top: 70px; 
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(45deg, rgba(0, 122, 255, 0.95), rgba(0, 188, 212, 0.95));
            color: white;
            padding: 12px 25px;
            border-radius: 15px;
            z-index: 800;
            text-align: center;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0, 122, 255, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
        }
        
        #escena-ar, #escena-vr {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: 1;
        }
        
        .oculto { display: none !important; }
        
        .mensaje-exito {
            color: #4CAF50;
            font-weight: bold;
        }
        
        .mensaje-error {
            color: #FF5252;
            font-weight: bold;
        }
        
        .vr-gafas-btn {
            position: fixed !important;
            top: 80px !important;
            right: 20px !important;
            background: linear-gradient(45deg, #FF9800, #F57C00) !important;
            color: white !important;
            border: none !important;
            padding: 12px 20px !important;
            border-radius: 50px !important;
            cursor: pointer !important;
            z-index: 1001 !important;
            display: flex !important;
            align-items: center !important;
            gap: 10px !important;
            font-weight: bold !important;
            font-size: 14px !important;
            transition: all 0.3s ease !important;
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3) !important;
            visibility: visible !important;
            opacity: 1 !important;
            backdrop-filter: blur(5px) !important;
            border: 2px solid rgba(255,255,255,0.3) !important;
        }
        
        .vr-gafas-btn:hover {
            background: linear-gradient(45deg, #F57C00, #EF6C00) !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 20px rgba(255, 152, 0, 0.4) !important;
        }
        
        .resultados-container {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
            box-sizing: border-box;
            overflow: visible;
        }
        
        .recomendaciones {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            padding: 25px;
            margin: 25px auto;
            max-width: 700px;
            text-align: left;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            box-sizing: border-box;
            word-wrap: break-word;
            overflow-wrap: break-word;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .recomendacion-item {
            margin: 12px 0;
            padding-left: 25px;
            position: relative;
            line-height: 1.6;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        .recomendacion-item:before {
            content: "‚ñ∏";
            color: #00BCD4;
            font-size: 18px;
            position: absolute;
            left: 0;
        }
        
        .botones-final {
            display: flex;
            gap: 20px;
            margin-top: 40px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .puntaje-final {
            font-size: 80px;
            margin: 20px;
            color: #FFD700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            font-weight: bold;
        }
        
        .contenido-conceptual {
            max-width: 900px;
            width: 100%;
            text-align: left;
            margin: 0 auto;
            padding: 10px;
        }
        
        .concepto-card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            padding: 25px;
            margin: 20px 0;
            border-left: 5px solid #00BCD4;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .concepto-imagen-container {
            width: 100%;
            max-width: 400px;
            height: 250px;
            margin: 15px auto;
            border-radius: 15px;
            border: 3px solid #00BCD4;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.05);
        }
        
        .diagrama {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
        }
        
        .concepto-titulo {
            color: #00BCD4;
            font-size: 26px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .concepto-lista {
            margin-left: 25px;
            margin-bottom: 20px;
            line-height: 1.8;
        }
        
        .concepto-lista li {
            margin: 8px 0;
        }

        #qr-visualizacion {
            position: fixed;
            bottom: 100px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            z-index: 2000;
            text-align: center;
            border: 3px solid #00BCD4;
        }
        
        #qr-visualizacion canvas {
            display: block;
            margin: 10px auto;
            border: 2px solid #333;
        }
        
        #btn-cerrar-qr {
            background: #FF5252;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            font-weight: bold;
        }
        
        .qr-info {
            color: #333;
            font-size: 14px;
            margin: 5px 0;
        }
        
        #contenedor-ar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1;
        }
        
        #contenedor-ar canvas {
            width: 100% !important;
            height: 100% !important;
            display: block !important;
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
        }
        
        #distancia-info {
            position: fixed;
            top: 130px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: #FFD700;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 801;
            border: 1px solid #00BCD4;
            backdrop-filter: blur(5px);
        }
        
        #ia-status {
            font-size: 12px;
            color: #00BCD4;
            margin-top: 5px;
        }
        #ia-progress-bar {
            width: 100%;
            height: 4px;
            background: #333;
            border-radius: 2px;
            margin-top: 5px;
            display: none;
        }
        #ia-progress-bar-fill {
            width: 0%;
            height: 100%;
            background: #00BCD4;
            border-radius: 2px;
            transition: width 0.3s;
        }
        .ia-verification {
            font-size: 10px;
            color: #87CEEB;
            margin-top: 5px;
            border-top: 1px dashed #00BCD4;
            padding-top: 5px;
            font-family: monospace;
        }
    </style>
    
    <!-- Import Maps para MindAR -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.128.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.128.0/examples/jsm/",
                "mindar-image-three": "https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-three.prod.js"
            }
        }
    </script>
    
    <!-- A-Frame para VR -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    
    <!-- QR Code Generator -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
</head>
<body>
    <!-- PANTALLA INICIAL -->
    <div id="conceptual">
        <h1 style="color: #00BCD4; margin-bottom: 20px; font-size: 3em; text-shadow: 0 0 20px rgba(0,188,212,0.5);">ARQUITECTO DE VISTAS + TUTOR IA</h1>
        <div style="color: #B0BEC5; margin-bottom: 30px; font-size: 18px; max-width: 600px;">
            Sistema Tutor Inteligente con RA y RV
        </div>
        <div style="text-align: left; max-width: 500px; margin-bottom: 30px; padding: 20px; background: rgba(255,255,255,0.05); border-radius: 15px; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.1);">
            <p><strong style="color: #00BCD4;">Caracter√≠sticas:</strong></p>
            <p>‚úÖ RA+RV+IA</p>
            <p>‚úÖ Inmersi√≥n visual</p>
            <p>‚úÖ Recomendaciones personalizadas por IA</p>
            <p>‚úÖ Verificaci√≥n visible en cada mensaje</p>
        </div>
        <button class="btn" onclick="window.mostrarConceptualizacion()">üìö ESTUDIAR CONCEPTOS</button>
        <button class="btn" onclick="window.comenzarActividad()">üöÄ COMENZAR PR√ÅCTICA</button>
    </div>

    <!-- PANTALLA CONCEPTUALIZACI√ìN -->
    <div id="conceptualizacion">
        <h1 style="color: #00BCD4; margin-bottom: 20px; text-shadow: 0 0 20px rgba(0,188,212,0.5);">üìö CONCEPTUALIZACI√ìN</h1>
        
        <div class="contenido-conceptual">
            <!-- Concepto 1: Vista Frontal -->
            <div class="concepto-card">
                <h2 class="concepto-titulo">üéØ 1. Vista Frontal</h2>
                <p>La <strong style="color: #00BCD4;">vista frontal</strong> es la representaci√≥n de un objeto como se ve desde el frente, mostrando su altura y anchura pero sin profundidad.</p>
                
                <div class="concepto-imagen-container">
                    <div class="diagrama" style="background: linear-gradient(45deg, #2C3E50, #34495E);">
                        <div style="width: 120px; height: 160px; background: linear-gradient(45deg, #8B4513, #A0522D); border: 3px solid #00BCD4; position: relative; box-shadow: 0 0 20px rgba(0,188,212,0.3);">
                            <div style="position: absolute; width: 110px; height: 150px; background: #87CEEB; opacity: 0.7; top: 5px; left: 5px;"></div>
                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">FRONTAL</div>
                        </div>
                    </div>
                </div>
                <p style="text-align: center; font-style: italic; color: #B0BEC5;">Representaci√≥n de una ventana en vista frontal</p>
                
                <h3 style="color: #00BCD4; margin-top: 20px;">Caracter√≠sticas principales:</h3>
                <ul class="concepto-lista">
                    <li>Se obtiene mirando el objeto de frente</li>
                    <li>Muestra las dimensiones verticales y horizontales</li>
                    <li>No muestra la profundidad</li>
                    <li>Es la vista m√°s com√∫n en planos arquitect√≥nicos</li>
                    <li>Representa c√≥mo ver√≠as el objeto si estuvieras parado frente a √©l</li>
                </ul>
            </div>
            
            <!-- Concepto 2: Vista Superior -->
            <div class="concepto-card">
                <h2 class="concepto-titulo">üõ∏ 2. Vista Superior</h2>
                <p>La <strong style="color: #00BCD4;">vista superior</strong> (tambi√©n llamada vista en planta) muestra el objeto desde arriba, como si lo mir√°ramos desde un avi√≥n.</p>
                
                <div class="concepto-imagen-container">
                    <div class="diagrama" style="background: linear-gradient(45deg, #1565C0, #1976D2);">
                        <div style="width: 150px; height: 100px; background: #2196F3; position: relative; border: 2px solid #FFD700; box-shadow: 0 0 20px rgba(255,215,0,0.3);">
                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-weight: bold;">PLANTA</div>
                            <div style="position: absolute; width: 60px; height: 30px; background: rgba(255, 255, 255, 0.8); top: 35px; left: 45px;"></div>
                        </div>
                    </div>
                </div>
                <p style="text-align: center; font-style: italic; color: #B0BEC5;">Representaci√≥n de una planta arquitect√≥nica</p>
                
                <h3 style="color: #00BCD4; margin-top: 20px;">¬øC√≥mo obtenerla?</h3>
                <ul class="concepto-lista">
                    <li>Debes <strong>trasladarte</strong> hasta quedar sobre el objeto</li>
                    <li>NO se obtiene rotando el objeto</li>
                    <li>Muestra la relaci√≥n espacial entre componentes</li>
                    <li>Esencial para planos de distribuci√≥n</li>
                    <li>Te permite ver la "huella" del objeto en el espacio</li>
                </ul>
            </div>
            
            <!-- Concepto 3: Conexi√≥n 2D-3D -->
            <div class="concepto-card">
                <h2 class="concepto-titulo">üîó 3. Conexi√≥n entre Vistas 2D y 3D</h2>
                <p>Las vistas 2D (como planos) son <strong style="color: #00BCD4;">proyecciones</strong> de objetos 3D desde diferentes posiciones.</p>
                
                <div class="concepto-imagen-container">
                    <div class="diagrama" style="background: linear-gradient(45deg, #1A237E, #283593);">
                        <div style="display: flex; align-items: center; gap: 20px;">
                            <div style="width: 80px; height: 80px; background: linear-gradient(45deg, #4CAF50, #388E3C); transform: perspective(300px) rotateX(20deg) rotateY(20deg); position: relative; box-shadow: 0 0 20px rgba(76,175,80,0.5);">
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 12px;">3D</div>
                            </div>
                            <div style="color: #FFD700; font-size: 24px;">‚Üí</div>
                            <div style="width: 100px; height: 60px; background: linear-gradient(45deg, #FF9800, #F57C00); position: relative; box-shadow: 0 0 20px rgba(255,152,0,0.5);">
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 12px;">2D</div>
                            </div>
                        </div>
                    </div>
                </div>
                <p style="text-align: center; font-style: italic; color: #B0BEC5;">Transformaci√≥n de objeto 3D a vista 2D</p>
                
                <h3 style="color: #00BCD4; margin-top: 20px;">Relaciones importantes:</h3>
                <ul class="concepto-lista">
                    <li>La <strong>vista frontal 2D</strong> se obtiene desde posici√≥n frontal en 3D</li>
                    <li>La <strong>vista superior 2D</strong> se obtiene desde posici√≥n superior en 3D</li>
                    <li>La <strong>vista lateral 2D</strong> se obtiene desde posici√≥n lateral en 3D</li>
                    <li>Cada vista muestra informaci√≥n diferente del mismo objeto</li>
                    <li>Combinando varias vistas 2D puedes reconstruir mentalmente el objeto 3D</li>
                </ul>
            </div>
            
            <!-- Informaci√≥n sobre QR -->
            <div class="concepto-card" style="background: linear-gradient(135deg, rgba(0, 188, 212, 0.15), rgba(0, 122, 255, 0.15)); border-left: 5px solid #FFD700;">
                <h2 style="color: #FFD700; text-align: center;">üì± QR ESPECIAL</h2>
                <p>En esta actividad usar√°s un c√≥digo QR personalizado con la palabra <strong>"ARQUITECTO"</strong> para activar la realidad aumentada:</p>
                <ol class="concepto-lista">
                    <li><strong>Fase 1:</strong> Escanea el QR para ver la vista frontal del objeto en 3D</li>
                    <li><strong>Fase 3:</strong> Escanea el QR para ver el plano 2D del objeto</li>
                </ol>
                <p style="text-align: center; margin-top: 15px;">
                    <button class="btn" style="max-width: 200px; padding: 10px;" onclick="mostrarQR()">üîç VER QR</button>
                </p>
            </div>
            
            <!-- Ejercicio de pr√°ctica mental -->
            <div class="concepto-card" style="background: linear-gradient(135deg, rgba(0, 188, 212, 0.15), rgba(0, 122, 255, 0.15)); border-left: 5px solid #FFD700;">
                <h2 style="color: #FFD700; text-align: center;">üß† ¬øListo para practicar?</h2>
                <p>Ahora aplicar√°s estos conceptos en una actividad interactiva:</p>
                <ol class="concepto-lista">
                    <li><strong>Fase 1:</strong> Usar√°s Realidad Aumentada con QR "ARQUITECTO" para ver la vista frontal</li>
                    <li><strong>Fase 2:</strong> Explorar√°s en Realidad Virtual para encontrar la vista superior</li>
                    <li><strong>Fase 3:</strong> Conectar√°s las vistas 2D con posiciones 3D usando QR</li>
                </ol>
                <p><strong>Recuerda:</strong> No se trata de memorizar, sino de entender c√≥mo se relacionan las diferentes representaciones de un objeto.</p>
            </div>
        </div>
        
        <div style="margin-top: 30px; margin-bottom: 30px; display: flex; gap: 20px; flex-wrap: wrap; justify-content: center;">
            <button class="btn" onclick="volverInicio()">üè† VOLVER AL INICIO</button>
            <button class="btn" onclick="comenzarActividad()">üöÄ COMENZAR PR√ÅCTICA</button>
        </div>
    </div>

    <!-- BARRA SUPERIOR -->
    <div id="barra-superior" class="oculto">
        <div id="fase-actual" style="font-size: 18px; font-weight: bold;">Fase 1: Vista Frontal</div>
        <div id="puntaje" style="font-size: 18px; font-weight: bold;">Puntos: <span style="color: #FFD700;">0</span></div>
    </div>

    <!-- INDICADOR AR (solo visible en Fase 1 y 3) -->
    <div id="indicador-ar" class="oculto">üì± Escanea el QR con la palabra "ARQUITECTO"</div>
    
    <!-- INFO DE DISTANCIA (solo visible en AR) -->
    <div id="distancia-info" class="oculto">üìè Distancia: <span id="distancia-valor">0</span> cm</div>

    <!-- ESCENAS -->
    <div id="escena-ar" class="oculto"></div>
    <div id="contenedor-ar" class="oculto" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1;"></div>
    <div id="escena-vr" class="oculto"></div>

    <!-- PANEL IA -->
    <div id="panel-ia" class="oculto">
        <div id="mensaje-ia">Preparando actividad...</div>
        <div id="ia-status"></div>
        <div id="ia-progress-bar">
            <div id="ia-progress-bar-fill"></div>
        </div>
        <div id="contenedor-opciones" style="margin-top: 15px;"></div>
        <div id="ia-verification" class="ia-verification"></div>
    </div>

    <!-- RESULTADOS -->
    <div id="resultados">
        <div class="resultados-container">
            <h1 style="color: #00BCD4; margin-bottom: 10px; font-size: 2.5em; text-shadow: 0 0 20px rgba(0,188,212,0.5);">üéâ ACTIVIDAD COMPLETADA</h1>
            <div style="color: #B0BEC5; margin-bottom: 30px; font-size: 18px;">
                An√°lisis generado por el tutor IA
            </div>
            
            <div class="puntaje-final" id="puntaje-final">0</div>
            <h3 style="margin-bottom: 30px; color: #B0BEC5;">PUNTUACI√ìN FINAL</h3>
            
            <div class="recomendaciones" id="recomendaciones-container">
                <!-- Las recomendaciones se generar√°n din√°micamente con IA -->
            </div>
            
            <div class="botones-final">
                <button class="btn" onclick="reiniciar()">üîÑ REPETIR ACTIVIDAD</button>
                <button class="btn" onclick="volverInicio()">üè† VOLVER AL INICIO</button>
            </div>
        </div>
    </div>

    <!-- VISUALIZACI√ìN QR -->
    <div id="qr-visualizacion" style="display: none;">
        <div style="font-weight: bold; color: #1976D2;">QR "ARQUITECTO"</div>
        <canvas id="qr-canvas" width="200" height="200"></canvas>
        <div class="qr-info">Escanea este c√≥digo QR para activar RA</div>
        <button id="btn-cerrar-qr" onclick="cerrarQR()">Cerrar</button>
    </div>

    <script type="module">
        // ============================================
        // IMPORTACIONES
        // ============================================
        import * as THREE from 'three';
        import { MindARThree } from 'mindar-image-three';

        // ============================================
        // CONFIGURACI√ìN DE LOGS
        // ============================================
        const LOG_URL = 'https://script.google.com/macros/s/AKfycbzgSxgwQQgiT3aDp7Vn6staeY4-Evpz9n68bg2JxIAYanQjJm12thZ2yc3HNaQCqXLO/exec';
        
        let estudianteId = localStorage.getItem('estudianteId');
        if (!estudianteId) {
            estudianteId = 'est_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('estudianteId', estudianteId);
        }

        let tiempoInicioFase = null;
        let tiemposPorFase = { 0: 0, 1: 0, 2: 0 };

        function iniciarTemporizadorFase(numFase) {
            tiempoInicioFase = Date.now();
        }

        function guardarTiempoFase(numFase) {
            if (tiempoInicioFase) {
                tiemposPorFase[numFase] = Date.now() - tiempoInicioFase;
                tiempoInicioFase = null;
            }
        }

        async function enviarLog(evento, objetoActual = null, opcionElegida = null, correcto = null, puntos = 0, metadata = {}) {
            try {
                const timestamp = new Date().toISOString();
                
                let fase = '';
                let objeto = '';
                let tiempoRespuesta = 0;
                
                switch(faseActual) {
                    case 0:
                        fase = 'Fase 1 - Vista Frontal';
                        objeto = objetoFase1 ? objetoFase1.nombre : 'desconocido';
                        tiempoRespuesta = tiemposPorFase[0];
                        break;
                    case 1:
                        fase = 'Fase 2 - Vista Superior';
                        objeto = objetoFase2 ? objetoFase2.nombre : 'desconocido';
                        tiempoRespuesta = tiemposPorFase[1];
                        break;
                    case 2:
                        fase = 'Fase 3 - Conexi√≥n';
                        objeto = objetoFase3 ? objetoFase3.nombre : 'desconocido';
                        tiempoRespuesta = tiemposPorFase[2];
                        break;
                    default:
                        fase = 'Conceptualizaci√≥n';
                }
                
                if (objetoActual) {
                    objeto = objetoActual;
                }
                
                const logData = {
                    timestamp: timestamp,
                    estudianteId: estudianteId,
                    fase: fase,
                    evento: evento,
                    objetoActual: objeto,
                    opcionElegida: opcionElegida || '',
                    correcto: correcto !== null ? (correcto ? 'S√≠' : 'No') : '',
                    puntos: puntos || 0,
                    tiempoRespuesta: tiempoRespuesta,
                    metadata: JSON.stringify({
                        puntajeTotal: puntaje,
                        tiemposPorFase: tiemposPorFase,
                        ...metadata
                    })
                };
                
                console.log('Enviando log:', logData);
                
                await fetch(LOG_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(logData)
                });
                
            } catch (error) {
                console.error('Error enviando log:', error);
            }
        }

        // ============================================
        // BASE DE DATOS DE OBJETOS ARQUITECT√ìNICOS
        // ============================================
        const objetosArquitectonicos = [
            {
                id: 1,
                nombre: "Ventana Arqueada",
                descripcion: "Ventana con arco superior y detalles ornamentales",
                tipo: "ventana",
                colorMarco: "#8B4513",
                colorVidrio: "#87CEEB",
                colorDetalles: "#DAA520",
                ancho: 1.8,
                alto: 2.2,
                profundidad: 0.15,
                textura: "madera",
                caracteristicas: "Su arco de medio punto distribuye las cargas hacia los lados, permitiendo vanos m√°s amplios sin perder estabilidad. T√≠pico del rom√°nico.",
                ejercicioComplementario: "Dibuja una ventana arqueada en vista frontal y luego intenta representar c√≥mo ser√≠a su planta (vista superior). Observa c√≥mo el arco se proyecta como una l√≠nea curva en planta."
            },
            {
                id: 2,
                nombre: "Puerta Principal",
                descripcion: "Puerta de entrada con detalles tallados y manija ornamental",
                tipo: "puerta",
                colorMadera: "#654321",
                colorMetal: "#C0C0C0",
                colorDetalles: "#8B7355",
                ancho: 1.2,
                alto: 2.4,
                profundidad: 0.1,
                textura: "madera_tallada",
                caracteristicas: "Los paneles de madera tallada no solo son decorativos, sino que refuerzan la estructura y evitan deformaciones. T√©cnica del Renacimiento.",
                ejercicioComplementario: "Observa una puerta real y analiza c√≥mo cambiar√≠a su representaci√≥n en vista frontal vs vista superior. En planta, ¬øqu√© forma tiene el umbral?"
            },
            {
                id: 3,
                nombre: "Columna Corintia",
                descripcion: "Columna cl√°sica con capitel ornamentado y base detallada",
                tipo: "columna",
                colorMarmol: "#E8E8E8",
                colorDetalles: "#D3D3D3",
                colorBase: "#A9A9A9",
                ancho: 0.9,
                alto: 3.0,
                profundidad: 0.9,
                textura: "marmol",
                caracteristicas: "El capitel con hojas de acanto representa el orden m√°s ornamentado de la arquitectura cl√°sica griega. La altura total es aproximadamente 10 veces su di√°metro.",
                ejercicioComplementario: "Identifica columnas en edificios de tu ciudad y clasif√≠calas por su orden arquitect√≥nico (d√≥rico, j√≥nico, corintio). Dibuja sus diferentes vistas."
            },
            {
                id: 4,
                nombre: "Escalera Caracol",
                descripcion: "Escalera en espiral con baranda de metal y pelda√±os de madera",
                tipo: "escalera",
                colorMadera: "#DEB887",
                colorMetal: "#708090",
                colorPeldanos: "#D2B48C",
                ancho: 2.5,
                alto: 2.8,
                profundidad: 2.5,
                textura: "madera_metal",
                caracteristicas: "La forma helicoidal optimiza el espacio vertical y es estructuralmente autoportante. Com√∫n en torres medievales y faros.",
                ejercicioComplementario: "Dibuja la proyecci√≥n en planta de una escalera caracol y compara con su alzado. ¬øC√≥mo se representa el giro en 2D?"
            },
            {
                id: 5,
                nombre: "Arco Triunfal",
                descripcion: "Estructura monumental con arco central y columnas laterales",
                tipo: "arco",
                colorPiedra: "#B8B8B8",
                colorDetalles: "#808080",
                colorRelieve: "#989898",
                ancho: 3.0,
                alto: 4.0,
                profundidad: 1.5,
                textura: "piedra_tallada",
                caracteristicas: "S√≠mbolo de poder en la arquitectura romana. El arco de medio punto permite luces grandes y el √°tico superior serv√≠a para inscripciones conmemorativas.",
                ejercicioComplementario: "Investiga el Arco de Constantino en Roma y analiza sus proporciones en alzado y planta. ¬øQu√© relaci√≥n hay entre el ancho del arco y su altura?"
            }
        ];

        // ============================================
        // FUNCIONES PARA CREAR OBJETOS 3D (FASE 1)
        // ============================================
        
        function crearVentana(objeto) {
            const grupo = new THREE.Group();
            
            const texturaMadera = (color) => {
                return new THREE.MeshStandardMaterial({ 
                    color: color, 
                    roughness: 0.6, 
                    metalness: 0.2,
                    emissive: new THREE.Color(0x221100),
                    emissiveIntensity: 0.1
                });
            };
            
            const marcoGeo = new THREE.BoxGeometry(objeto.ancho, objeto.alto, objeto.profundidad);
            const marcoMat = texturaMadera(objeto.colorMarco);
            const marco = new THREE.Mesh(marcoGeo, marcoMat);
            marco.position.y = objeto.alto / 2;
            marco.castShadow = true;
            marco.receiveShadow = true;
            grupo.add(marco);
            
            const vidrioGeo = new THREE.BoxGeometry(objeto.ancho * 0.9, objeto.alto * 0.9, 0.05);
            const vidrioMat = new THREE.MeshStandardMaterial({ 
                color: objeto.colorVidrio, 
                transparent: true, 
                opacity: 0.6, 
                roughness: 0.1, 
                metalness: 0.9,
                emissive: new THREE.Color(0x112233),
                emissiveIntensity: 0.2
            });
            const vidrio = new THREE.Mesh(vidrioGeo, vidrioMat);
            vidrio.position.set(0, objeto.alto / 2, objeto.profundidad / 2 + 0.06);
            vidrio.castShadow = true;
            vidrio.receiveShadow = true;
            grupo.add(vidrio);
            
            const divisorVGeo = new THREE.BoxGeometry(0.05, objeto.alto * 0.9, 0.04);
            const divisorMat = new THREE.MeshStandardMaterial({ 
                color: objeto.colorDetalles, 
                roughness: 0.4, 
                metalness: 0.8,
                emissive: new THREE.Color(0x442200),
                emissiveIntensity: 0.2
            });
            
            const divisor1 = new THREE.Mesh(divisorVGeo, divisorMat);
            divisor1.position.set(-objeto.ancho * 0.225, objeto.alto / 2, 0.12);
            divisor1.castShadow = true;
            grupo.add(divisor1);
            
            const divisor2 = new THREE.Mesh(divisorVGeo, divisorMat);
            divisor2.position.set(objeto.ancho * 0.225, objeto.alto / 2, 0.12);
            divisor2.castShadow = true;
            grupo.add(divisor2);
            
            const arcoGeo = new THREE.TorusGeometry(objeto.ancho * 0.125, 0.04, 16, 32, Math.PI);
            const arcoMat = new THREE.MeshStandardMaterial({ 
                color: objeto.colorDetalles, 
                roughness: 0.4, 
                metalness: 0.8,
                emissive: new THREE.Color(0x442200),
                emissiveIntensity: 0.2
            });
            const arco = new THREE.Mesh(arcoGeo, arcoMat);
            arco.rotation.x = Math.PI / 2;
            arco.rotation.z = Math.PI;
            arco.position.set(0, objeto.alto * 0.9, 0.12);
            arco.scale.set(1.2, 1, 1);
            arco.castShadow = true;
            grupo.add(arco);
            
            const baseGeo = new THREE.BoxGeometry(objeto.ancho * 0.9, 0.1, 0.04);
            const baseMat = texturaMadera(objeto.colorMarco);
            const base = new THREE.Mesh(baseGeo, baseMat);
            base.position.set(0, 0.05, 0.12);
            base.castShadow = true;
            grupo.add(base);
            
            const plataformaGeo = new THREE.BoxGeometry(objeto.ancho * 1.5, 0.05, objeto.profundidad * 2);
            const plataformaMat = new THREE.MeshStandardMaterial({ 
                color: "#5D4037", 
                roughness: 0.9,
                emissive: new THREE.Color(0x221100),
                emissiveIntensity: 0.1
            });
            const plataforma = new THREE.Mesh(plataformaGeo, plataformaMat);
            plataforma.position.set(0, -0.05, 0);
            plataforma.receiveShadow = true;
            plataforma.castShadow = true;
            grupo.add(plataforma);
            
            return grupo;
        }
        
        function crearPuerta(objeto) {
            const grupo = new THREE.Group();
            
            const maderaMat = new THREE.MeshStandardMaterial({ 
                color: objeto.colorMadera, 
                roughness: 0.7, 
                metalness: 0.1,
                emissive: new THREE.Color(0x221100),
                emissiveIntensity: 0.1
            });
            
            const marcoGeo = new THREE.BoxGeometry(objeto.ancho, objeto.alto, objeto.profundidad);
            const marco = new THREE.Mesh(marcoGeo, maderaMat);
            marco.position.y = objeto.alto / 2;
            marco.castShadow = true;
            marco.receiveShadow = true;
            grupo.add(marco);
            
            const panelGeo = new THREE.BoxGeometry(objeto.ancho * 0.8, objeto.alto * 0.25, 0.04);
            const panelMat = new THREE.MeshStandardMaterial({ 
                color: objeto.colorDetalles, 
                roughness: 0.8,
                emissive: new THREE.Color(0x332211),
                emissiveIntensity: 0.1
            });
            
            for (let i = 0; i < 3; i++) {
                const panel = new THREE.Mesh(panelGeo, panelMat);
                panel.position.set(0, objeto.alto * (0.7 - i * 0.3), 0.06);
                panel.castShadow = true;
                grupo.add(panel);
            }
            
            const manijaGeo = new THREE.SphereGeometry(0.04, 16, 16);
            const manijaMat = new THREE.MeshStandardMaterial({ 
                color: objeto.colorMetal, 
                metalness: 0.9, 
                roughness: 0.2,
                emissive: new THREE.Color(0x333333),
                emissiveIntensity: 0.3
            });
            const manija = new THREE.Mesh(manijaGeo, manijaMat);
            manija.position.set(objeto.ancho * 0.35, objeto.alto / 2, 0.08);
            manija.castShadow = true;
            grupo.add(manija);
            
            const marcoExtGeo = new THREE.BoxGeometry(objeto.ancho * 1.1, objeto.alto * 1.05, 0.08);
            const marcoExtMat = new THREE.MeshStandardMaterial({ 
                color: "#5D4037", 
                roughness: 0.9,
                emissive: new THREE.Color(0x221100),
                emissiveIntensity: 0.1
            });
            const marcoExt = new THREE.Mesh(marcoExtGeo, marcoExtMat);
            marcoExt.position.set(0, objeto.alto / 2, -0.05);
            marcoExt.castShadow = true;
            marcoExt.receiveShadow = true;
            grupo.add(marcoExt);
            
            const dintelGeo = new THREE.BoxGeometry(objeto.ancho * 1.2, 0.15, 0.2);
            const dintelMat = new THREE.MeshStandardMaterial({ 
                color: "#5D4037", 
                roughness: 0.9,
                emissive: new THREE.Color(0x221100),
                emissiveIntensity: 0.1
            });
            const dintel = new THREE.Mesh(dintelGeo, dintelMat);
            dintel.position.set(0, objeto.alto + 0.1, 0);
            dintel.castShadow = true;
            dintel.receiveShadow = true;
            grupo.add(dintel);
            
            return grupo;
        }
        
        function crearColumna(objeto) {
            const grupo = new THREE.Group();
            
            const baseGeo = new THREE.CylinderGeometry(objeto.ancho * 0.6, objeto.ancho * 0.6, 0.4, 16);
            const baseMat = new THREE.MeshStandardMaterial({ 
                color: objeto.colorBase, 
                roughness: 0.6,
                emissive: new THREE.Color(0x222222),
                emissiveIntensity: 0.1
            });
            const base = new THREE.Mesh(baseGeo, baseMat);
            base.position.y = 0.2;
            base.castShadow = true;
            base.receiveShadow = true;
            grupo.add(base);
            
            const fusteGeo = new THREE.CylinderGeometry(objeto.ancho * 0.35, objeto.ancho * 0.35, objeto.alto * 0.8, 20);
            const fusteMat = new THREE.MeshStandardMaterial({ 
                color: objeto.colorMarmol, 
                roughness: 0.4, 
                metalness: 0.3,
                emissive: new THREE.Color(0x333333),
                emissiveIntensity: 0.1
            });
            const fuste = new THREE.Mesh(fusteGeo, fusteMat);
            fuste.position.y = objeto.alto * 0.5;
            fuste.castShadow = true;
            fuste.receiveShadow = true;
            grupo.add(fuste);
            
            const capitelBaseGeo = new THREE.CylinderGeometry(objeto.ancho * 0.45, objeto.ancho * 0.45, 0.4, 24);
            const capitelBaseMat = new THREE.MeshStandardMaterial({ 
                color: objeto.colorDetalles, 
                roughness: 0.5,
                emissive: new THREE.Color(0x444444),
                emissiveIntensity: 0.2
            });
            const capitelBase = new THREE.Mesh(capitelBaseGeo, capitelBaseMat);
            capitelBase.position.y = objeto.alto * 0.9 + 0.2;
            capitelBase.castShadow = true;
            grupo.add(capitelBase);
            
            const capitelSupGeo = new THREE.ConeGeometry(objeto.ancho * 0.4, 0.3, 8);
            const capitelSupMat = new THREE.MeshStandardMaterial({ 
                color: objeto.colorDetalles, 
                roughness: 0.5,
                emissive: new THREE.Color(0x444444),
                emissiveIntensity: 0.2
            });
            const capitelSup = new THREE.Mesh(capitelSupGeo, capitelSupMat);
            capitelSup.position.y = objeto.alto * 0.9 + 0.5;
            capitelSup.castShadow = true;
            grupo.add(capitelSup);
            
            const decoracionMat = new THREE.MeshStandardMaterial({ 
                color: objeto.colorMarmol, 
                roughness: 0.5,
                emissive: new THREE.Color(0x333333),
                emissiveIntensity: 0.1
            });
            
            for (let i = 0; i < 4; i++) {
                const angulo = (i * Math.PI / 2);
                const x = Math.cos(angulo) * objeto.ancho * 0.3;
                const z = Math.sin(angulo) * objeto.ancho * 0.3;
                
                const volutaGeo = new THREE.TorusGeometry(0.1, 0.03, 8, 16, Math.PI);
                const volutaMat = new THREE.MeshStandardMaterial({ color: objeto.colorMarmol, emissive: new THREE.Color(0x333333), emissiveIntensity: 0.1 });
                const voluta = new THREE.Mesh(volutaGeo, volutaMat);
                voluta.position.set(x, objeto.alto * 0.9 + 0.3, z);
                voluta.rotation.y = angulo;
                voluta.rotation.x = Math.PI / 2;
                voluta.castShadow = true;
                grupo.add(voluta);
            }
            
            return grupo;
        }
        
        function crearEscalera(objeto) {
            const grupo = new THREE.Group();
            
            const baseGeo = new THREE.CylinderGeometry(objeto.ancho/2, objeto.ancho/2, 0.2, 16);
            const baseMat = new THREE.MeshStandardMaterial({ 
                color: "#5D4037", 
                roughness: 0.9,
                emissive: new THREE.Color(0x221100),
                emissiveIntensity: 0.1
            });
            const base = new THREE.Mesh(baseGeo, baseMat);
            base.position.y = 0.1;
            base.receiveShadow = true;
            base.castShadow = true;
            grupo.add(base);
            
            const columnaGeo = new THREE.CylinderGeometry(0.1, 0.1, objeto.alto, 8);
            const columnaMat = new THREE.MeshStandardMaterial({ 
                color: objeto.colorMetal, 
                metalness: 0.8, 
                roughness: 0.3,
                emissive: new THREE.Color(0x333333),
                emissiveIntensity: 0.2
            });
            const columna = new THREE.Mesh(columnaGeo, columnaMat);
            columna.position.y = objeto.alto / 2;
            columna.castShadow = true;
            grupo.add(columna);
            
            const numPelda√±os = 12;
            const alturaPorPelda√±o = objeto.alto / numPelda√±os;
            
            for (let i = 0; i < numPelda√±os; i++) {
                const y = i * alturaPorPelda√±o + alturaPorPelda√±o/2;
                const angulo = i * (Math.PI * 2 / numPelda√±os);
                const radio = objeto.ancho/2 - 0.2;
                const x = Math.cos(angulo) * radio;
                const z = Math.sin(angulo) * radio;
                
                const pelda√±oGeo = new THREE.BoxGeometry(0.6, 0.05, 0.2);
                const pelda√±oMat = new THREE.MeshStandardMaterial({ 
                    color: objeto.colorMadera, 
                    roughness: 0.8,
                    emissive: new THREE.Color(0x332211),
                    emissiveIntensity: 0.1
                });
                const pelda√±o = new THREE.Mesh(pelda√±oGeo, pelda√±oMat);
                pelda√±o.position.set(x, y, z);
                pelda√±o.rotation.y = -angulo;
                pelda√±o.castShadow = true;
                pelda√±o.receiveShadow = true;
                grupo.add(pelda√±o);
            }
            
            return grupo;
        }
        
        function crearArco(objeto) {
            const grupo = new THREE.Group();
            
            const piedraMat = new THREE.MeshStandardMaterial({ 
                color: objeto.colorPiedra, 
                roughness: 0.7,
                emissive: new THREE.Color(0x222222),
                emissiveIntensity: 0.1
            });
            
            const baseGeo = new THREE.BoxGeometry(objeto.ancho, 0.2, objeto.profundidad);
            const base = new THREE.Mesh(baseGeo, piedraMat);
            base.position.y = 0.1;
            base.castShadow = true;
            base.receiveShadow = true;
            grupo.add(base);
            
            const columnaGeo = new THREE.CylinderGeometry(0.2, 0.2, objeto.alto * 0.8, 8);
            
            const columnaIzq = new THREE.Mesh(columnaGeo, piedraMat);
            columnaIzq.position.set(-objeto.ancho * 0.35, objeto.alto * 0.4, 0);
            columnaIzq.castShadow = true;
            columnaIzq.receiveShadow = true;
            grupo.add(columnaIzq);
            
            const columnaDer = new THREE.Mesh(columnaGeo, piedraMat);
            columnaDer.position.set(objeto.ancho * 0.35, objeto.alto * 0.4, 0);
            columnaDer.castShadow = true;
            columnaDer.receiveShadow = true;
            grupo.add(columnaDer);
            
            const arcoGeo = new THREE.TorusGeometry(objeto.ancho * 0.25, 0.15, 8, 24, Math.PI);
            const arcoMat = new THREE.MeshStandardMaterial({ 
                color: objeto.colorPiedra, 
                roughness: 0.6,
                emissive: new THREE.Color(0x333333),
                emissiveIntensity: 0.1
            });
            const arco = new THREE.Mesh(arcoGeo, arcoMat);
            arco.rotation.x = Math.PI / 2;
            arco.rotation.z = Math.PI / 2;
            arco.position.set(0, objeto.alto * 0.8, 0);
            arco.castShadow = true;
            grupo.add(arco);
            
            const dintelGeo = new THREE.BoxGeometry(objeto.ancho, 0.3, objeto.profundidad * 0.8);
            const dintelMat = new THREE.MeshStandardMaterial({ 
                color: objeto.colorDetalles, 
                roughness: 0.7,
                emissive: new THREE.Color(0x333333),
                emissiveIntensity: 0.1
            });
            const dintel = new THREE.Mesh(dintelGeo, dintelMat);
            dintel.position.set(0, objeto.alto * 1.1, 0);
            dintel.castShadow = true;
            dintel.receiveShadow = true;
            grupo.add(dintel);
            
            return grupo;
        }

        function crearObjeto3D(objeto) {
            switch(objeto.tipo) {
                case 'ventana': return crearVentana(objeto);
                case 'puerta': return crearPuerta(objeto);
                case 'columna': return crearColumna(objeto);
                case 'escalera': return crearEscalera(objeto);
                case 'arco': return crearArco(objeto);
                default: return crearVentana(objeto);
            }
        }

        // ============================================
        // FUNCIONES PARA CREAR PLANOS 2D (FASE 3)
        // ============================================
        
        function crearTexturaPlano(objeto, color, forma) {
            const canvas = document.createElement('canvas');
            canvas.width = 512;
            canvas.height = 512;
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.strokeStyle = '#CCCCCC';
            ctx.lineWidth = 10;
            ctx.strokeRect(10, 10, canvas.width - 20, canvas.height - 20);
            
            ctx.fillStyle = color;
            ctx.strokeStyle = '#333333';
            ctx.lineWidth = 8;
            
            const centroX = canvas.width / 2;
            const centroY = canvas.height / 2;
            
            switch(forma) {
                case 'ventana':
                    ctx.fillStyle = '#8B4513';
                    ctx.fillRect(centroX - 150, centroY - 200, 300, 400);
                    
                    ctx.fillStyle = '#87CEEB';
                    ctx.globalAlpha = 0.6;
                    ctx.fillRect(centroX - 130, centroY - 180, 260, 360);
                    
                    ctx.globalAlpha = 1.0;
                    ctx.strokeStyle = '#DAA520';
                    ctx.lineWidth = 8;
                    ctx.beginPath();
                    ctx.moveTo(centroX, centroY - 180);
                    ctx.lineTo(centroX, centroY + 180);
                    ctx.stroke();
                    
                    ctx.beginPath();
                    ctx.moveTo(centroX - 130, centroY);
                    ctx.lineTo(centroX + 130, centroY);
                    ctx.stroke();
                    
                    ctx.strokeStyle = '#DAA520';
                    ctx.lineWidth = 12;
                    ctx.beginPath();
                    ctx.arc(centroX, centroY - 180, 100, 0, Math.PI);
                    ctx.stroke();
                    break;
                    
                case 'puerta':
                    ctx.fillStyle = '#654321';
                    ctx.fillRect(centroX - 100, centroY - 200, 200, 400);
                    
                    ctx.fillStyle = '#8B7355';
                    ctx.fillRect(centroX - 70, centroY - 150, 140, 80);
                    ctx.fillRect(centroX - 70, centroY - 50, 140, 80);
                    ctx.fillRect(centroX - 70, centroY + 50, 140, 80);
                    
                    ctx.fillStyle = '#C0C0C0';
                    ctx.beginPath();
                    ctx.arc(centroX + 60, centroY, 15, 0, 2 * Math.PI);
                    ctx.fill();
                    break;
                    
                case 'columna':
                    ctx.fillStyle = '#A9A9A9';
                    ctx.beginPath();
                    ctx.arc(centroX, centroY, 150, 0, 2 * Math.PI);
                    ctx.fill();
                    
                    ctx.fillStyle = '#E8E8E8';
                    ctx.beginPath();
                    ctx.arc(centroX, centroY, 100, 0, 2 * Math.PI);
                    ctx.fill();
                    
                    ctx.strokeStyle = '#D3D3D3';
                    ctx.lineWidth = 10;
                    ctx.beginPath();
                    ctx.arc(centroX, centroY, 120, 0, 2 * Math.PI);
                    ctx.stroke();
                    
                    ctx.beginPath();
                    ctx.arc(centroX, centroY, 80, 0, 2 * Math.PI);
                    ctx.stroke();
                    break;
                    
                case 'escalera':
                    for (let i = 0; i < 8; i++) {
                        const angulo = (i / 8) * Math.PI * 2;
                        const radio = 50 + i * 30;
                        const x = centroX + Math.cos(angulo) * radio;
                        const y = centroY + Math.sin(angulo) * radio;
                        
                        ctx.fillStyle = i % 2 === 0 ? '#708090' : '#DEB887';
                        ctx.beginPath();
                        ctx.arc(x, y, 20, 0, 2 * Math.PI);
                        ctx.fill();
                    }
                    
                    ctx.strokeStyle = '#8B7355';
                    ctx.lineWidth = 6;
                    for (let i = 1; i <= 3; i++) {
                        ctx.beginPath();
                        ctx.arc(centroX, centroY, i * 60, 0, 2 * Math.PI);
                        ctx.stroke();
                    }
                    break;
                    
                case 'arco':
                    ctx.fillStyle = '#B8B8B8';
                    ctx.fillRect(centroX - 150, centroY - 150, 50, 300);
                    ctx.fillRect(centroX + 100, centroY - 150, 50, 300);
                    
                    ctx.strokeStyle = '#808080';
                    ctx.lineWidth = 20;
                    ctx.beginPath();
                    ctx.arc(centroX, centroY - 50, 150, 0, Math.PI);
                    ctx.stroke();
                    
                    ctx.fillStyle = '#989898';
                    ctx.fillRect(centroX - 180, centroY - 200, 360, 30);
                    break;
                    
                default:
                    ctx.fillStyle = '#00BCD4';
                    ctx.font = 'bold 40px Arial';
                    ctx.fillStyle = '#333333';
                    ctx.fillText('PLANO 2D', centroX - 100, centroY);
            }
            
            return new THREE.CanvasTexture(canvas);
        }
        
        function crearPlanoVentana(objeto) {
            const grupo = new THREE.Group();
            const textura = crearTexturaPlano(objeto, objeto.colorMarco, 'ventana');
            
            const geometry = new THREE.PlaneGeometry(2.0, 2.0);
            const material = new THREE.MeshStandardMaterial({ 
                map: textura,
                side: THREE.DoubleSide,
                emissive: new THREE.Color(0x333333),
                emissiveIntensity: 0.1
            });
            const plano = new THREE.Mesh(geometry, material);
            plano.rotation.x = -Math.PI / 2;
            plano.position.y = 0;
            plano.receiveShadow = true;
            
            grupo.add(plano);
            return grupo;
        }
        
        function crearPlanoPuerta(objeto) {
            const grupo = new THREE.Group();
            const textura = crearTexturaPlano(objeto, objeto.colorMadera, 'puerta');
            
            const geometry = new THREE.PlaneGeometry(2.0, 2.0);
            const material = new THREE.MeshStandardMaterial({ 
                map: textura,
                side: THREE.DoubleSide,
                emissive: new THREE.Color(0x333333),
                emissiveIntensity: 0.1
            });
            const plano = new THREE.Mesh(geometry, material);
            plano.rotation.x = -Math.PI / 2;
            plano.position.y = 0;
            
            grupo.add(plano);
            return grupo;
        }
        
        function crearPlanoColumna(objeto) {
            const grupo = new THREE.Group();
            const textura = crearTexturaPlano(objeto, objeto.colorMarmol, 'columna');
            
            const geometry = new THREE.PlaneGeometry(2.0, 2.0);
            const material = new THREE.MeshStandardMaterial({ 
                map: textura,
                side: THREE.DoubleSide,
                emissive: new THREE.Color(0x333333),
                emissiveIntensity: 0.1
            });
            const plano = new THREE.Mesh(geometry, material);
            plano.rotation.x = -Math.PI / 2;
            plano.position.y = 0;
            
            grupo.add(plano);
            return grupo;
        }
        
        function crearPlanoEscalera(objeto) {
            const grupo = new THREE.Group();
            const textura = crearTexturaPlano(objeto, objeto.colorMadera, 'escalera');
            
            const geometry = new THREE.PlaneGeometry(2.0, 2.0);
            const material = new THREE.MeshStandardMaterial({ 
                map: textura,
                side: THREE.DoubleSide,
                emissive: new THREE.Color(0x333333),
                emissiveIntensity: 0.1
            });
            const plano = new THREE.Mesh(geometry, material);
            plano.rotation.x = -Math.PI / 2;
            plano.position.y = 0;
            
            grupo.add(plano);
            return grupo;
        }
        
        function crearPlanoArco(objeto) {
            const grupo = new THREE.Group();
            const textura = crearTexturaPlano(objeto, objeto.colorPiedra, 'arco');
            
            const geometry = new THREE.PlaneGeometry(2.0, 2.0);
            const material = new THREE.MeshStandardMaterial({ 
                map: textura,
                side: THREE.DoubleSide,
                emissive: new THREE.Color(0x333333),
                emissiveIntensity: 0.1
            });
            const plano = new THREE.Mesh(geometry, material);
            plano.rotation.x = -Math.PI / 2;
            plano.position.y = 0;
            
            grupo.add(plano);
            return grupo;
        }

        function crearPlano2D(objeto) {
            switch(objeto.tipo) {
                case 'ventana': return crearPlanoVentana(objeto);
                case 'puerta': return crearPlanoPuerta(objeto);
                case 'columna': return crearPlanoColumna(objeto);
                case 'escalera': return crearPlanoEscalera(objeto);
                case 'arco': return crearPlanoArco(objeto);
                default: return crearPlanoVentana(objeto);
            }
        }

        // ============================================
        // FUNCIONES DE NAVEGACI√ìN
        // ============================================
        
        function mostrarConceptualizacion() {
            document.getElementById('conceptual').style.display = 'none';
            document.getElementById('conceptualizacion').style.display = 'flex';
            document.getElementById('conceptualizacion').scrollTop = 0;
            enviarLog('Ver conceptualizaci√≥n');
        }
        
        function volverInicio() {
            if (tiempoInicioFase) {
                guardarTiempoFase(faseActual);
            }
            
            document.getElementById('conceptual').style.display = 'flex';
            document.getElementById('conceptualizacion').style.display = 'none';
            document.getElementById('resultados').style.display = 'none';
            document.getElementById('barra-superior').classList.add('oculto');
            document.getElementById('panel-ia').classList.add('oculto');
            document.getElementById('indicador-ar').classList.add('oculto');
            document.getElementById('escena-ar').classList.add('oculto');
            document.getElementById('contenedor-ar').classList.add('oculto');
            document.getElementById('escena-vr').classList.add('oculto');
            document.getElementById('qr-visualizacion').style.display = 'none';
            document.getElementById('distancia-info').classList.add('oculto');
            
            const contenedorAR = document.getElementById('contenedor-ar');
            contenedorAR.innerHTML = '';
            
            const escenaVR = document.getElementById('escena-vr');
            escenaVR.innerHTML = '';
            
            puntaje = 0;
            faseActual = 0;
            marcadorDetectado = false;
            respuestasUsuario = [];
            modoVR = false;
            fase2Respondida = false;
            fase3Respondida = false;
            fase2Avanzada = false;
            fase3Avanzada = false;
            tiemposPorFase = {0: 0, 1: 0, 2: 0};
            tiempoInicioFase = null;
            
            objetoFase1 = null;
            objetoFase2 = null;
            objetoFase3 = null;
            
            const botonVR = document.querySelector('.vr-gafas-btn');
            if (botonVR) botonVR.remove();
            
            enviarLog('Volver al inicio');
        }
        
        function comenzarActividad() {
            document.getElementById('conceptual').style.display = 'none';
            document.getElementById('conceptualizacion').style.display = 'none';
            document.getElementById('resultados').style.display = 'none';
            document.getElementById('qr-visualizacion').style.display = 'none';
            
            document.getElementById('barra-superior').classList.remove('oculto');
            document.getElementById('panel-ia').classList.remove('oculto');
            
            fase2Respondida = false;
            fase3Respondida = false;
            fase2Avanzada = false;
            fase3Avanzada = false;
            puntaje = 0;
            respuestasUsuario = [];
            tiemposPorFase = {0: 0, 1: 0, 2: 0};
            tiempoInicioFase = null;
            
            document.querySelector('#puntaje span').textContent = puntaje;
            
            objetoFase1 = seleccionarObjetoAleatorio();
            objetoFase2 = seleccionarObjetoAleatorio();
            objetoFase3 = seleccionarObjetoAleatorio();
            
            enviarLog('Iniciar actividad', 'general', null, null, 0, {
                objetos: {
                    fase1: objetoFase1.nombre,
                    fase2: objetoFase2.nombre,
                    fase3: objetoFase3.nombre
                }
            });
            
            iniciarFase(0);
        }
        
        function reiniciar() {
            enviarLog('Reiniciar actividad');
            volverInicio();
            setTimeout(() => comenzarActividad(), 100);
        }

        function seleccionarObjetoAleatorio() {
            const indice = Math.floor(Math.random() * objetosArquitectonicos.length);
            return objetosArquitectonicos[indice];
        }

        // ============================================
        // VARIABLES GLOBALES
        // ============================================
        let puntaje = 0;
        let faseActual = 0;
        let marcadorDetectado = false;
        let respuestasUsuario = [];
        let modoVR = false;
        let botonVR = null;
        let escenaVR = null;
        let fase2Respondida = false;
        let fase3Respondida = false;
        let fase2Avanzada = false;
        let fase3Avanzada = false;
        
        let objetoFase1 = null;
        let objetoFase2 = null;
        let objetoFase3 = null;
        
        let mindarInstance = null;
        let anchorDetectado = false;
        let objetoActualAR = null;
        let distanciaBase = 30;

        let numeroSesion = Math.floor(Math.random() * 10000);
        let modoIA = true;

        // ============================================
        // FUNCI√ìN PARA DETENER MINDAR
        // ============================================
        async function detenerMindAR() {
            if (mindarInstance) {
                try {
                    await mindarInstance.stop();
                    mindarInstance = null;
                } catch (e) {
                    console.log('Error deteniendo MindAR:', e);
                }
            }
            anchorDetectado = false;
            objetoActualAR = null;
        }

        // ============================================
        // FUNCIONES QR
        // ============================================
        
        function mostrarQR() {
            const qrDiv = document.getElementById('qr-visualizacion');
            const canvas = document.getElementById('qr-canvas');
            
            QRCode.toCanvas(canvas, 'ARQUITECTO', { width: 200, margin: 2 }, function(error) {
                if (error) console.error('Error generando QR:', error);
                else {
                    qrDiv.style.display = 'block';
                    enviarLog('Ver QR', faseActual === 0 ? objetoFase1.nombre : objetoFase3.nombre);
                }
            });
        }
        
        function cerrarQR() {
            document.getElementById('qr-visualizacion').style.display = 'none';
        }

        window.mostrarQR = mostrarQR;
        window.cerrarQR = cerrarQR;

        // ============================================
        // FUNCI√ìN DE ESCALADO DIN√ÅMICO
        // ============================================
        function actualizarEscalaPorDistancia(objetoMesh, distanciaEstimada) {
            if (!objetoMesh) return;
            
            const distanciaCm = Math.max(10, Math.min(100, distanciaEstimada));
            const factorEscala = 0.08 + (30 / distanciaCm) * 0.42;
            const escalaFinal = Math.min(0.5, Math.max(0.08, factorEscala));
            
            objetoMesh.scale.set(escalaFinal, escalaFinal, escalaFinal);
            document.getElementById('distancia-valor').textContent = Math.round(distanciaCm);
        }

        // ============================================
        // IA: GENERAR RESPUESTA √öNICA (SIN MODELO PESADO)
        // ============================================
        async function generarRespuestaUnica(contexto) {
            const ahora = new Date();
            const timestamp = ahora.toLocaleTimeString();
            const idUnico = Math.floor(Math.random() * 10000);
            
            // Respuestas predefinidas pero con combinaciones aleatorias
            const respuesta = generarRespuestaDinamica(contexto);
            
            document.getElementById('ia-verification').innerHTML = 
                `üÜî Sesi√≥n: ${numeroSesion} | ‚è±Ô∏è ${timestamp} | üé≤ ID: ${idUnico}`;
            
            return `${respuesta}\n\n---\nüÜî Sesi√≥n #${numeroSesion} | ‚è±Ô∏è ${timestamp} | üé≤ ID: ${idUnico}`;
        }

        function generarRespuestaDinamica(contexto) {
            const { tipo, objeto, esCorrecto, opcion, puntosGanados, fase } = contexto;
            
            // Arrays de frases para variar las respuestas
            const saludos = ["Hola", "Bienvenido", "Qu√© tal", "Saludos", "Te damos la bienvenida"];
            const felicitaciones = ["Excelente", "Muy bien", "Perfecto", "Buen trabajo", "Acertaste", "Correcto"];
            const reconocimientos = ["Bien", "Correcto", "Acertaste", "Vas bien"];
            const mejorables = ["Has acertado, pero puedes mejorar", "Correcto, aunque hay margen de mejora", "Bien, pero practica m√°s"];
            const consejos = ["Recuerda", "No olvides", "Ten en cuenta", "Considera", "Observa que"];
            const errores = ["Casi", "Por poco", "No es correcto", "Observa con atenci√≥n", "Revisa el concepto"];
            
            const saludo = saludos[Math.floor(Math.random() * saludos.length)];
            const felicita = felicitaciones[Math.floor(Math.random() * felicitaciones.length)];
            const reconoce = reconocimientos[Math.floor(Math.random() * reconocimientos.length)];
            const mejora = mejorables[Math.floor(Math.random() * mejorables.length)];
            const consejo = consejos[Math.floor(Math.random() * consejos.length)];
            const error = errores[Math.floor(Math.random() * errores.length)];
            
            if (tipo === 'bienvenida') {
                return `${saludo} a la Fase ${fase+1}. Trabajaremos con ${objeto.nombre}. ${objeto.caracteristicas} ${consejo} observar bien las proporciones y detalles arquitect√≥nicos.`;
            }
            else if (tipo === 'validacion') {
                if (esCorrecto) {
                    if (puntosGanados === 30) {
                        return `¬°${felicita}! Obtuviste el m√°ximo puntaje con ${objeto.nombre}. ${objeto.caracteristicas} Tu precisi√≥n es excelente. ¬°Sigue as√≠!`;
                    } else if (puntosGanados === 20) {
                        return `${reconoce} con ${objeto.nombre}. ${objeto.caracteristicas} Puedes mejorar la precisi√≥n para obtener m√°ximo puntaje.`;
                    } else {
                        return `${mejora} con ${objeto.nombre}. ${objeto.caracteristicas} Observa mejor los detalles la pr√≥xima vez.`;
                    }
                } else {
                    return `${error}. La opci√≥n "${opcion}" no es correcta para ${objeto.nombre}. ${objeto.caracteristicas} Intenta de nuevo con m√°s atenci√≥n.`;
                }
            }
            else {
                const actividades = [
                    `Para seguir mejorando con ${objetoFase1?.nombre || 'objetos arquitect√≥nicos'}: ${objetoFase1?.ejercicioComplementario || 'Practica dibujando diferentes vistas'}`,
                    `Para reforzar con ${objetoFase2?.nombre || 'vistas superiores'}: ${objetoFase2?.ejercicioComplementario || 'Analiza las proporciones en edificios reales'}`,
                    `Para conectar conceptos con ${objetoFase3?.nombre || 'proyecciones'}: ${objetoFase3?.ejercicioComplementario || 'Dibuja tus propias proyecciones 2D-3D'}`
                ];
                
                const preguntas = [
                    `¬øC√≥mo crees que cambiar√≠a la vista frontal del ${objetoFase1?.nombre} si modificaras su altura?`,
                    `¬øQu√© relaci√≥n encuentras entre la vista superior del ${objetoFase2?.nombre} y su funci√≥n arquitect√≥nica?`,
                    `¬øPor qu√© crees que es importante dominar las diferentes vistas en arquitectura?`,
                    `¬øC√≥mo aplicar√≠as estos conceptos de vistas en el dise√±o de un edificio real?`
                ];
                
                const pregunta = preguntas[Math.floor(Math.random() * preguntas.length)];
                
                return `Has completado la actividad con ${puntaje} puntos. 
                
                EVALUACI√ìN: ${puntaje >= 80 ? 'Excelente dominio de vistas arquitect√≥nicas' : puntaje >= 60 ? 'Buen desempe√±o, puedes seguir mejorando' : 'Necesitas practicar m√°s los conceptos b√°sicos'}.
                
                RECOMENDACIONES:
                1. ${actividades[0]}
                2. ${actividades[1]}
                3. ${actividades[2]}
                
                PREGUNTA PARA REFLEXIONAR: ${pregunta}
                
                ¬°Sigue practicando y ver√°s c√≥mo mejora tu comprensi√≥n espacial!`;
            }
        }

        // ============================================
        // INICIAR FASE
        // ============================================
        async function iniciarFase(numFase) {
            if (tiempoInicioFase) {
                guardarTiempoFase(faseActual);
            }
            
            faseActual = numFase;
            marcadorDetectado = false;
            iniciarTemporizadorFase(numFase);
            
            let objetoActual = '';
            switch(numFase) {
                case 0: objetoActual = objetoFase1.nombre; break;
                case 1: objetoActual = objetoFase2.nombre; break;
                case 2: objetoActual = objetoFase3.nombre; break;
            }
            enviarLog('Iniciar fase', objetoActual);
            
            if (botonVR) {
                botonVR.remove();
                botonVR = null;
            }
            modoVR = false;
            
            await detenerMindAR();
            
            document.getElementById('escena-ar').classList.add('oculto');
            document.getElementById('contenedor-ar').classList.add('oculto');
            document.getElementById('escena-vr').classList.add('oculto');
            document.getElementById('distancia-info').classList.add('oculto');
            
            const contenedorAR = document.getElementById('contenedor-ar');
            contenedorAR.innerHTML = '';
            
            let objetoFase = null;
            if (numFase === 0) objetoFase = objetoFase1;
            else if (numFase === 1) objetoFase = objetoFase2;
            else objetoFase = objetoFase3;
            
            const mensajeBienvenida = await generarRespuestaUnica({
                tipo: 'bienvenida',
                objeto: objetoFase,
                fase: numFase
            });
            
            if (numFase === 0) {
                document.getElementById('fase-actual').textContent = `Fase 1: Vista Frontal - ${objetoFase1.nombre}`;
                
                document.getElementById('mensaje-ia').innerHTML = 
                    `<strong>üéì TUTOR IA - FASE 1:</strong><br>` +
                    `${mensajeBienvenida}<br>` +
                    `<br><button class="btn" style="max-width: 200px; padding: 8px; margin-top: 10px;" onclick="mostrarQR()">üîç VER QR</button>`;
                
                const contenedor = document.getElementById('contenedor-opciones');
                contenedor.innerHTML = '';
                
                const boton = document.createElement('button');
                boton.className = 'opcion-btn';
                boton.textContent = `VALIDAR VISTA FRONTAL DEL ${objetoFase1.nombre.toUpperCase()}`;
                boton.id = 'boton-validar';
                boton.onclick = validarVistaFrontal;
                contenedor.appendChild(boton);
                
                document.getElementById('indicador-ar').classList.remove('oculto');
                document.getElementById('indicador-ar').innerHTML = 'üì± Escanea el QR con la palabra "ARQUITECTO"';
                document.getElementById('indicador-ar').style.background = 'linear-gradient(45deg, rgba(0, 122, 255, 0.95), rgba(0, 188, 212, 0.95))';
                
                configurarMindAR(false);
                
            } else if (numFase === 1) {
                document.getElementById('fase-actual').textContent = `Fase 2: Vista Superior - ${objetoFase2.nombre}`;
                
                document.getElementById('mensaje-ia').innerHTML = 
                    `<strong>üéì TUTOR IA - FASE 2:</strong><br>` +
                    `${mensajeBienvenida}<br>` +
                    `<small style='color:#B0BEC5'>Usa las teclas WASD para moverte y el mouse para mirar alrededor</small>`;
                
                const contenedor = document.getElementById('contenedor-opciones');
                contenedor.innerHTML = '';
                
                const opciones = ['TRASLADARME', 'ROTAR OBJETO'];
                opciones.forEach(opcion => {
                    const boton = document.createElement('button');
                    boton.className = 'opcion-btn';
                    boton.textContent = opcion;
                    boton.onclick = () => validarVistaSuperior(opcion);
                    contenedor.appendChild(boton);
                });
                
                document.getElementById('indicador-ar').classList.add('oculto');
                document.getElementById('distancia-info').classList.add('oculto');
                
                configurarEscenaVRMejorada();
                
            } else if (numFase === 2) {
                document.getElementById('fase-actual').textContent = `Fase 3: Conexi√≥n - ${objetoFase3.nombre}`;
                
                document.getElementById('mensaje-ia').innerHTML = 
                    `<strong>üéì TUTOR IA - FASE 3:</strong><br>` +
                    `${mensajeBienvenida}<br>` +
                    `<button class="btn" style="max-width: 200px; padding: 8px; margin-top: 10px;" onclick="mostrarQR()">üîç VER QR</button>`;
                
                const contenedor = document.getElementById('contenedor-opciones');
                contenedor.innerHTML = '';
                
                const opciones = ['POSICI√ìN SUPERIOR', 'POSICI√ìN FRONTAL', 'POSICI√ìN LATERAL'];
                opciones.forEach(opcion => {
                    const boton = document.createElement('button');
                    boton.className = 'opcion-btn';
                    boton.textContent = opcion;
                    boton.onclick = () => validarConexion(opcion);
                    contenedor.appendChild(boton);
                });
                
                document.getElementById('indicador-ar').classList.remove('oculto');
                document.getElementById('indicador-ar').innerHTML = 'üì± Escanea el QR para ver el PLANO 2D';
                document.getElementById('indicador-ar').style.background = 'linear-gradient(45deg, #4CAF50, #388E3C)';
                
                configurarMindAR(true);
            }
        }

        // ============================================
        // CONFIGURAR MINDAR (FASE 1 Y 3)
        // ============================================
        async function configurarMindAR(esVistaPlanta) {
            document.getElementById('indicador-ar').classList.remove('oculto');
            document.getElementById('contenedor-ar').classList.remove('oculto');
            document.getElementById('distancia-info').classList.remove('oculto');
            
            const objeto = esVistaPlanta ? objetoFase3 : objetoFase1;
            const container = document.getElementById('contenedor-ar');
            container.innerHTML = '';
            
            try {
                const response = await fetch('./assets/qr-arquitecto.mind');
                if (!response.ok) {
                    throw new Error('Archivo .mind no encontrado en assets/');
                }
                
                const mindarThree = new MindARThree({
                    container: container,
                    imageTargetSrc: './assets/qr-arquitecto.mind',
                    filterMinCF: 0.001,
                    filterBeta: 0.001,
                });

                mindarInstance = mindarThree;
                const { renderer, scene, camera } = mindarThree;

                renderer.shadowMap.enabled = true;
                renderer.shadowMap.type = THREE.PCFSoftShadowMap;

                const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
                scene.add(ambientLight);
                
                const dirLight = new THREE.DirectionalLight(0xffffff, 1.5);
                dirLight.position.set(2, 5, 3);
                dirLight.castShadow = true;
                dirLight.shadow.mapSize.width = 1024;
                dirLight.shadow.mapSize.height = 1024;
                scene.add(dirLight);
                
                const fillLight = new THREE.PointLight(0x446688, 0.5);
                fillLight.position.set(-2, 3, 2);
                scene.add(fillLight);

                let objetoVisual;
                if (esVistaPlanta) {
                    objetoVisual = crearPlano2D(objeto);
                } else {
                    objetoVisual = crearObjeto3D(objeto);
                }
                
                objetoVisual.position.y = 0;
                objetoVisual.position.x = 0;
                objetoVisual.position.z = 0;
                
                if (!esVistaPlanta) {
                    objetoVisual.scale.set(0.08, 0.08, 0.08);
                } else {
                    objetoVisual.scale.set(0.5, 0.5, 0.5);
                }
                
                objetoVisual.castShadow = true;
                objetoVisual.receiveShadow = true;
                objetoActualAR = objetoVisual;

                const anchor = mindarThree.addAnchor(0);
                anchor.group.add(objetoVisual);

                anchor.onTargetFound = () => {
                    document.getElementById('indicador-ar').innerHTML = '‚úÖ QR DETECTADO';
                    document.getElementById('indicador-ar').style.background = 'linear-gradient(45deg, #4CAF50, #388E3C)';
                    anchorDetectado = true;
                    
                    enviarLog('QR detectado', objeto.nombre);
                    
                    function escaladoLoop() {
                        if (anchorDetectado && mindarInstance) {
                            const distancia = 30 + Math.sin(Date.now() / 1000) * 15;
                            actualizarEscalaPorDistancia(objetoActualAR, distancia);
                        }
                        requestAnimationFrame(escaladoLoop);
                    }
                    escaladoLoop();
                };
                
                anchor.onTargetLost = () => {
                    if (esVistaPlanta) {
                        document.getElementById('indicador-ar').innerHTML = 'üì± Escanea el QR para ver el PLANO 2D';
                        document.getElementById('indicador-ar').style.background = 'linear-gradient(45deg, #4CAF50, #388E3C)';
                    } else {
                        document.getElementById('indicador-ar').innerHTML = 'üì± Escanea el QR con la palabra "ARQUITECTO"';
                        document.getElementById('indicador-ar').style.background = 'linear-gradient(45deg, rgba(0, 122, 255, 0.95), rgba(0, 188, 212, 0.95))';
                    }
                    anchorDetectado = false;
                    
                    enviarLog('QR perdido', objeto.nombre);
                };

                await mindarThree.start();
                
                renderer.setAnimationLoop(() => {
                    renderer.render(scene, camera);
                });

            } catch (error) {
                console.error('Error MindAR:', error);
                document.getElementById('indicador-ar').innerHTML = '‚ùå Error: ' + error.message;
                enviarLog('Error AR', objeto.nombre, null, null, 0, { error: error.message });
            }
        }

        // ============================================
        // CONFIGURAR ESCENA VR (FASE 2)
        // ============================================
        function configurarEscenaVRMejorada() {
            document.getElementById('indicador-ar').classList.add('oculto');
            document.getElementById('escena-vr').classList.remove('oculto');
            document.getElementById('distancia-info').classList.add('oculto');
            
            const objeto = objetoFase2;
            
            enviarLog('Entrar a VR', objeto.nombre);
            
            function generarHTMLObjetoVR(objeto) {
                let html = '';
                
                switch(objeto.tipo) {
                    case 'ventana':
                        html = `
                            <a-box position="0 ${objeto.alto/2} 0" 
                                   width="${objeto.ancho}" 
                                   height="${objeto.alto}" 
                                   depth="${objeto.profundidad}" 
                                   color="${objeto.colorMarco}"
                                   roughness="0.6"
                                   metalness="0.3"
                                   emissive="#221100"
                                   emissiveIntensity="0.1"
                                   shadow="cast: true; receive: true">
                                <a-box position="0 0 0.06" 
                                       width="${objeto.ancho * 0.9}" 
                                       height="${objeto.alto * 0.9}" 
                                       depth="0.05" 
                                       color="${objeto.colorVidrio}" 
                                       opacity="0.7"
                                       roughness="0.1"
                                       metalness="0.9"></a-box>
                                <a-box position="${objeto.ancho * -0.225} 0 0.07" 
                                       width="0.05" 
                                       height="${objeto.alto * 0.9}" 
                                       depth="0.04" 
                                       color="${objeto.colorDetalles}"
                                       roughness="0.4"
                                       metalness="0.8"
                                       emissive="#442200"
                                       emissiveIntensity="0.2"></a-box>
                                <a-box position="${objeto.ancho * 0.225} 0 0.07" 
                                       width="0.05" 
                                       height="${objeto.alto * 0.9}" 
                                       depth="0.04" 
                                       color="${objeto.colorDetalles}"
                                       roughness="0.4"
                                       metalness="0.8"
                                       emissive="#442200"
                                       emissiveIntensity="0.2"></a-box>
                                <a-cylinder position="0 ${objeto.alto * 0.45} 0.07" 
                                           height="0.04" 
                                           radius="${objeto.ancho * 0.125}" 
                                           color="${objeto.colorDetalles}"
                                           rotation="90 0 0"
                                           open-ended="true"
                                           theta-length="180"
                                           roughness="0.4"
                                           metalness="0.8"
                                           emissive="#442200"
                                           emissiveIntensity="0.2"></a-cylinder>
                                <a-box position="0 ${objeto.alto * -0.45} 0.07" 
                                       width="${objeto.ancho * 0.9}" 
                                       height="0.1" 
                                       depth="0.04" 
                                       color="${objeto.colorMarco}"
                                       roughness="0.8"></a-box>
                            </a-box>
                            <a-box position="0 ${objeto.alto * -0.55} 0.1" 
                                   width="${objeto.ancho * 1.2}" 
                                   height="0.05" 
                                   depth="0.15" 
                                   color="#5D4037"
                                   roughness="0.9"
                                   shadow="cast: true; receive: true"></a-box>
                        `;
                        break;
                        
                    case 'puerta':
                        html = `
                            <a-box position="0 ${objeto.alto/2} 0" 
                                   width="${objeto.ancho}" 
                                   height="${objeto.alto}" 
                                   depth="${objeto.profundidad}" 
                                   color="${objeto.colorMadera}"
                                   roughness="0.7"
                                   metalness="0.1"
                                   emissive="#221100"
                                   emissiveIntensity="0.1"
                                   shadow="cast: true; receive: true">
                                <a-box position="0 ${objeto.alto * 0.3} 0.06" 
                                       width="${objeto.ancho * 0.8}" 
                                       height="${objeto.alto * 0.25}" 
                                       depth="0.04" 
                                       color="${objeto.colorDetalles}"
                                       roughness="0.8"
                                       emissive="#332211"
                                       emissiveIntensity="0.1"></a-box>
                                <a-box position="0 ${objeto.alto * -0.1} 0.06" 
                                       width="${objeto.ancho * 0.8}" 
                                       height="${objeto.alto * 0.25}" 
                                       depth="0.04" 
                                       color="${objeto.colorDetalles}"
                                       roughness="0.8"
                                       emissive="#332211"
                                       emissiveIntensity="0.1"></a-box>
                                <a-cylinder position="${objeto.ancho * 0.35} 0 0.08" 
                                           radius="0.04" 
                                           height="0.02" 
                                           color="${objeto.colorMetal}"
                                           metalness="0.9"
                                           roughness="0.2"
                                           emissive="#333333"
                                           emissiveIntensity="0.3"></a-cylinder>
                                <a-torus position="${objeto.ancho * 0.4} 0 0.08" 
                                        radius="0.03" 
                                        radius-tubular="0.008" 
                                        color="${objeto.colorMetal}"
                                        metalness="0.9"
                                        arc="180"
                                        rotation="0 90 0"
                                        emissive="#333333"
                                        emissiveIntensity="0.3"></a-torus>
                            </a-box>
                            <a-box position="0 ${objeto.alto/2} ${objeto.profundidad * -0.6}" 
                                   width="${objeto.ancho * 1.1}" 
                                   height="${objeto.alto * 1.05}" 
                                   depth="0.08" 
                                   color="#5D4037"
                                   roughness="0.9"
                                   shadow="cast: true; receive: true"></a-box>
                            <a-box position="0 ${objeto.alto + 0.1} 0" 
                                   width="${objeto.ancho * 1.2}" 
                                   height="0.15" 
                                   depth="0.2" 
                                   color="#5D4037"
                                   roughness="0.9"
                                   shadow="cast: true; receive: true"></a-box>
                        `;
                        break;
                        
                    case 'columna':
                        html = `
                            <a-cylinder position="0 0.2 0" 
                                       radius="${objeto.ancho * 0.6}" 
                                       height="0.4" 
                                       color="${objeto.colorBase}"
                                       roughness="0.6"
                                       shadow="cast: true; receive: true"></a-cylinder>
                            <a-cylinder position="0 ${objeto.alto * 0.5} 0" 
                                       radius="${objeto.ancho * 0.35}" 
                                       height="${objeto.alto * 0.8}" 
                                       color="${objeto.colorMarmol}"
                                       roughness="0.4"
                                       metalness="0.3"
                                       emissive="#333333"
                                       emissiveIntensity="0.1"
                                       shadow="cast: true; receive: true"></a-cylinder>
                            <a-entity position="0 ${objeto.alto * 0.9} 0">
                                <a-cylinder position="0 0.2 0" 
                                           radius="${objeto.ancho * 0.45}" 
                                           height="0.4" 
                                           color="${objeto.colorDetalles}"
                                           roughness="0.5"
                                           emissive="#444444"
                                           emissiveIntensity="0.2"
                                           shadow="cast: true"></a-cylinder>
                                <a-cone position="0 0.4 0" 
                                       radius-bottom="${objeto.ancho * 0.4}" 
                                       radius-top="${objeto.ancho * 0.3}" 
                                       height="0.3" 
                                       color="${objeto.colorDetalles}"
                                       roughness="0.5"
                                       emissive="#444444"
                                       emissiveIntensity="0.2"
                                       shadow="cast: true"></a-cone>
                            </a-entity>
                        `;
                        break;
                        
                    case 'escalera':
                        html = `
                            <a-entity position="0 ${objeto.alto/2} 0">
                                <a-cylinder position="0 ${-objeto.alto/2 + 0.1} 0" 
                                           radius="${objeto.ancho/2}" 
                                           height="0.2" 
                                           color="#5D4037"
                                           roughness="0.9"
                                           shadow="cast: true; receive: true"></a-cylinder>
                                <a-cylinder position="0 ${objeto.alto * 0.1} 0" 
                                           radius="0.1" 
                                           height="${objeto.alto}" 
                                           color="${objeto.colorMetal}"
                                           metalness="0.8"
                                           roughness="0.3"
                                           emissive="#333333"
                                           emissiveIntensity="0.2"
                                           shadow="cast: true"></a-cylinder>
                                ${Array.from({ length: 12 }, (_, i) => {
                                    const y = i * (objeto.alto / 12) + (objeto.alto / 24);
                                    const angulo = i * (Math.PI * 2 / 12);
                                    const radio = objeto.ancho/2 - 0.2;
                                    const x = Math.cos(angulo) * radio;
                                    const z = Math.sin(angulo) * radio;
                                    return `
                                        <a-box position="${x} ${y} ${z}" 
                                               width="0.6" 
                                               height="0.05" 
                                               depth="0.2" 
                                               color="${objeto.colorMadera}"
                                               rotation="0 ${-angulo * 180/Math.PI} 0"
                                               roughness="0.8"
                                               emissive="#332211"
                                               emissiveIntensity="0.1"
                                               shadow="cast: true; receive: true"></a-box>
                                    `;
                                }).join('')}
                                <a-torus position="0 ${objeto.alto * 0.9} 0" 
                                        radius="${objeto.ancho/2 - 0.1}" 
                                        radius-tubular="0.02" 
                                        color="${objeto.colorMetal}"
                                        metalness="0.8"
                                        rotation="90 0 0"
                                        shadow="cast: true"></a-torus>
                            </a-entity>
                        `;
                        break;
                        
                    case 'arco':
                        html = `
                            <a-box position="0 ${objeto.alto * 0.1} 0" 
                                   width="${objeto.ancho}" 
                                   height="0.2" 
                                   depth="${objeto.profundidad}" 
                                   color="${objeto.colorPiedra}"
                                   roughness="0.7"
                                   emissive="#222222"
                                   emissiveIntensity="0.1"
                                   shadow="cast: true; receive: true"></a-box>
                            <a-cylinder position="${objeto.ancho * -0.35} ${objeto.alto * 0.6} 0" 
                                       radius="0.2" 
                                       height="${objeto.alto * 0.8}" 
                                       color="${objeto.colorPiedra}"
                                       roughness="0.6"
                                       emissive="#333333"
                                       emissiveIntensity="0.1"
                                       shadow="cast: true; receive: true"></a-cylinder>
                            <a-cylinder position="${objeto.ancho * 0.35} ${objeto.alto * 0.6} 0" 
                                       radius="0.2" 
                                       height="${objeto.alto * 0.8}" 
                                       color="${objeto.colorPiedra}"
                                       roughness="0.6"
                                       emissive="#333333"
                                       emissiveIntensity="0.1"
                                       shadow="cast: true; receive: true"></a-cylinder>
                            <a-torus position="0 ${objeto.alto * 0.8} 0" 
                                    radius="${objeto.ancho * 0.25}" 
                                    radius-tubular="0.15" 
                                    color="${objeto.colorPiedra}"
                                    arc="180"
                                    rotation="0 0 90"
                                    roughness="0.6"
                                    emissive="#333333"
                                    emissiveIntensity="0.1"
                                    shadow="cast: true"></a-torus>
                        `;
                        break;
                }
                
                return html;
            }
            
            const escenaHTML = `
                <a-scene 
                    embedded 
                    vr-mode-ui="enabled: true"
                    renderer="antialias: true; precision: high; physicallyCorrectLights: true; shadowMapEnabled: true"
                >
                    <a-sky color="#87CEEB"></a-sky>
                    
                    <a-entity geometry="primitive: plane; width: 30; height: 30" 
                             rotation="-90 0 0" 
                             material="src: https://cdn.aframe.io/a-painter/images/floor.jpg; repeat: 10 10; roughness: 0.8; metalness: 0.2"
                             position="0 0 0"
                             shadow="receive: true"></a-entity>
                    
                    <a-entity light="type: ambient; color: #FFFFFF; intensity: 0.6"></a-entity>
                    <a-entity light="type: directional; color: #FFFFFF; intensity: 1.2" position="5 10 5" cast-shadow="true"></a-entity>
                    <a-entity light="type: point; color: #88AAFF; intensity: 0.5" position="0 5 0"></a-entity>
                    
                    <a-entity position="0 1.5 -6" scale="1.2 1.2 1.2">
                        ${generarHTMLObjetoVR(objeto)}
                        
                        <a-cylinder position="0 ${-objeto.alto/2 - 0.2} 0" 
                                   radius="${Math.max(objeto.ancho, objeto.profundidad) * 0.8}" 
                                   height="0.4" 
                                   color="#5D4037"
                                   roughness="0.9"
                                   segments-radial="32"
                                   shadow="cast: true; receive: true"></a-cylinder>
                        
                        ${objeto.tipo === 'arco' || objeto.tipo === 'puerta' ? `
                            <a-box position="0 ${-objeto.alto/2 - 0.1} ${objeto.profundidad * 0.6}" 
                                   width="${objeto.ancho * 0.8}" 
                                   height="0.1" 
                                   depth="0.8" 
                                   color="#696969"
                                   roughness="0.9"
                                   shadow="cast: true; receive: true"></a-box>
                            <a-box position="0 ${-objeto.alto/2 - 0.05} ${objeto.profundidad * 0.9}" 
                                   width="${objeto.ancho * 0.7}" 
                                   height="0.1" 
                                   depth="0.6" 
                                   color="#808080"
                                   roughness="0.9"
                                   shadow="cast: true; receive: true"></a-box>
                        ` : ''}
                    </a-entity>
                    
                    <a-entity position="0 2.5 -3">
                        <a-text value="EXPLORA EL ${objeto.nombre.toUpperCase()}" 
                               align="center" 
                               color="#1976D2" 
                               width="3"
                               position="0 0.5 0"
                               shadow="true"
                               font="roboto"></a-text>
                        <a-text value="WASD: Moverse | Mouse: Mirar" 
                               align="center" 
                               color="#FFFFFF" 
                               width="2.5"
                               position="0 0.2 0"
                               opacity="0.8"
                               font="roboto"></a-text>
                        <a-text value="OBJETIVO: Encontrar la vista superior" 
                               align="center" 
                               color="#4CAF50" 
                               width="2.5"
                               position="0 -0.1 0"
                               opacity="0.9"
                               font="roboto"></a-text>
                    </a-entity>
                    
                    <a-entity 
                        id="main-camera"
                        camera="fov: 80; userHeight: 1.6" 
                        look-controls="pointerLockEnabled: true; touchEnabled: false"
                        wasd-controls="acceleration: 80; fly: false"
                        position="0 1.6 0">
                        <a-cursor fuse="true" fuse-timeout="500"
                                 material="color: #007AFF; shader: flat"
                                 geometry="primitive: ring; radiusInner: 0.008; radiusOuter: 0.012"
                                 animation__click="property: scale; startEvents: click; from: 0.1 0.1 0.1; to: 1 1 1; dur: 150"></a-cursor>
                    </a-entity>
                </a-scene>
            `;
            
            document.getElementById('escena-vr').innerHTML = escenaHTML;
            escenaVR = document.querySelector('#escena-vr a-scene');
            crearBotonVR();
        }

        function crearBotonVR() {
            if (botonVR) botonVR.remove();
            
            botonVR = document.createElement('button');
            botonVR.className = 'vr-gafas-btn';
            botonVR.id = 'btn-vr-gafas';
            botonVR.innerHTML = 'üëì ACTIVAR GAFAS VR';
            
            botonVR.onclick = toggleModoVR;
            document.body.appendChild(botonVR);
        }

        function toggleModoVR() {
            if (!escenaVR) {
                escenaVR = document.querySelector('#escena-vr a-scene');
                if (!escenaVR) return;
            }
            
            if (!modoVR) {
                escenaVR.enterVR().then(() => {
                    modoVR = true;
                    botonVR.innerHTML = 'üëì DESACTIVAR GAFAS VR';
                    botonVR.style.background = 'linear-gradient(45deg, #4CAF50, #388E3C)';
                    
                    enviarLog('Activar VR', faseActual === 1 ? objetoFase2.nombre : '');
                }).catch(() => {
                    modoVR = false;
                    botonVR.innerHTML = 'üëì ACTIVAR GAFAS VR';
                    botonVR.style.background = 'linear-gradient(45deg, #FF9800, #F57C00)';
                });
            } else {
                escenaVR.exitVR();
                modoVR = false;
                botonVR.innerHTML = 'üëì ACTIVAR GAFAS VR';
                botonVR.style.background = 'linear-gradient(45deg, #FF9800, #F57C00)';
                
                enviarLog('Desactivar VR', faseActual === 1 ? objetoFase2.nombre : '');
            }
        }

        // ============================================
        // FUNCIONES DE VALIDACI√ìN
        // ============================================
        
        async function validarVistaFrontal() {
            const boton = document.getElementById('boton-validar');
            if (boton) {
                boton.disabled = true;
                boton.textContent = "VALIDANDO...";
                boton.style.background = "#666";
            }
            
            guardarTiempoFase(0);
            
            const calidad = Math.random();
            let puntosGanados = 0;
            let esCorrecto = false;
            const objeto = objetoFase1;
            
            if (calidad > 0.7) {
                puntosGanados = 30;
                esCorrecto = true;
            } else if (calidad > 0.4) {
                puntosGanados = 20;
                esCorrecto = true;
            } else {
                puntosGanados = 10;
                esCorrecto = false;
            }
            
            const mensajeIA = await generarRespuestaUnica({
                tipo: 'validacion',
                objeto: objeto,
                esCorrecto: esCorrecto,
                puntosGanados: puntosGanados,
                fase: 0
            });
            
            const indexFase1 = respuestasUsuario.findIndex(r => r.fase === 1);
            if (indexFase1 === -1) {
                respuestasUsuario.push({
                    fase: 1,
                    objeto: objeto.nombre,
                    puntos: puntosGanados,
                    retroalimentacion: mensajeIA,
                    correcto: esCorrecto,
                    tiempo: tiemposPorFase[0]
                });
                
                puntaje += puntosGanados;
                document.querySelector('#puntaje span').textContent = puntaje;
                
                enviarLog('Validar vista frontal', objeto.nombre, 'VALIDAR', esCorrecto, puntosGanados, {
                    calidad: calidad,
                    tiempoMs: tiemposPorFase[0]
                });
            }
            
            document.getElementById('mensaje-ia').innerHTML = 
                `<strong>üéì TUTOR IA - FASE 1:</strong><br>` +
                `${esCorrecto ? '‚úÖ' : '‚ö†Ô∏è'} Validaci√≥n completada<br>+${puntosGanados} puntos<br><br>` +
                `${mensajeIA}<br><br>` +
                `‚è±Ô∏è Preparando Fase 2 en 12 segundos...`;
            
            setTimeout(() => iniciarFase(1), 12000);
        }
        
        async function validarVistaSuperior(opcion) {
            let correcto = opcion === "TRASLADARME";
            let puntosGanados = correcto ? 40 : 0;
            const objeto = objetoFase2;
            
            const mensajeIA = await generarRespuestaUnica({
                tipo: 'validacion',
                objeto: objeto,
                esCorrecto: correcto,
                opcion: opcion,
                puntosGanados: puntosGanados,
                fase: 1
            });
            
            const indexFase2 = respuestasUsuario.findIndex(r => r.fase === 2);
            
            if (indexFase2 === -1) {
                fase2Respondida = true;
                
                respuestasUsuario.push({
                    fase: 2,
                    objeto: objeto.nombre,
                    opcion: opcion,
                    correcto: correcto,
                    puntos: puntosGanados,
                    retroalimentacion: mensajeIA,
                    tiempo: correcto ? tiemposPorFase[1] : 0
                });
                
                if (correcto) {
                    guardarTiempoFase(1);
                    puntaje += puntosGanados;
                    document.querySelector('#puntaje span').textContent = puntaje;
                    
                    document.getElementById('mensaje-ia').innerHTML = 
                        `<strong>üéì TUTOR IA - FASE 2:</strong><br>` +
                        `<span class='mensaje-exito'>‚úÖ ¬°CORRECTO!</span><br>` +
                        `+${puntosGanados} puntos<br><br>` +
                        `${mensajeIA}<br><br>` +
                        `‚è±Ô∏è Preparando Fase 3 en 12 segundos...`;
                    
                    fase2Avanzada = true;
                    setTimeout(() => iniciarFase(2), 12000);
                    
                } else {
                    document.getElementById('mensaje-ia').innerHTML = 
                        `<strong>üéì TUTOR IA - FASE 2:</strong><br>` +
                        `<span class='mensaje-error'>‚ùå Intenta nuevamente</span><br>` +
                        `${mensajeIA}`;
                }
                
                enviarLog('Validar vista superior', objeto.nombre, opcion, correcto, puntosGanados, {
                    tiempoMs: tiemposPorFase[1]
                });
                
            } else if (correcto && !fase2Avanzada) {
                guardarTiempoFase(1);
                respuestasUsuario[indexFase2].opcion = opcion;
                respuestasUsuario[indexFase2].correcto = correcto;
                respuestasUsuario[indexFase2].retroalimentacion = mensajeIA;
                respuestasUsuario[indexFase2].tiempo = tiemposPorFase[1];
                
                document.getElementById('mensaje-ia').innerHTML = 
                    `<strong>üéì TUTOR IA - FASE 2:</strong><br>` +
                    `<span class='mensaje-exito'>‚úÖ ¬°Ahora es correcto!</span><br>` +
                    `${mensajeIA}<br><br>` +
                    `‚è±Ô∏è Preparando Fase 3 en 12 segundos...`;
                
                fase2Avanzada = true;
                setTimeout(() => iniciarFase(2), 12000);
                
                enviarLog('Validar vista superior (corregido)', objeto.nombre, opcion, correcto, 40, {
                    tiempoMs: tiemposPorFase[1]
                });
            }
        }
        
        async function validarConexion(opcion) {
            let correcto = opcion === "POSICI√ìN SUPERIOR";
            let puntosGanados = correcto ? 30 : 0;
            const objeto = objetoFase3;
            
            const mensajeIA = await generarRespuestaUnica({
                tipo: 'validacion',
                objeto: objeto,
                esCorrecto: correcto,
                opcion: opcion,
                puntosGanados: puntosGanados,
                fase: 2
            });
            
            const indexFase3 = respuestasUsuario.findIndex(r => r.fase === 3);
            
            if (indexFase3 === -1) {
                fase3Respondida = true;
                
                respuestasUsuario.push({
                    fase: 3,
                    objeto: objeto.nombre,
                    opcion: opcion,
                    correcto: correcto,
                    puntos: puntosGanados,
                    retroalimentacion: mensajeIA,
                    tiempo: correcto ? tiemposPorFase[2] : 0
                });
                
                if (correcto) {
                    guardarTiempoFase(2);
                    puntaje += puntosGanados;
                    document.querySelector('#puntaje span').textContent = puntaje;
                    
                    document.getElementById('mensaje-ia').innerHTML = 
                        `<strong>üéì TUTOR IA - FASE 3:</strong><br>` +
                        `<span class='mensaje-exito'>‚úÖ ¬°EXCELENTE!</span><br>` +
                        `+${puntosGanados} puntos<br><br>` +
                        `${mensajeIA}<br><br>` +
                        `‚è±Ô∏è Generando an√°lisis final...`;
                    
                    fase3Avanzada = true;
                    setTimeout(() => mostrarResultados(), 12000);
                    
                } else {
                    document.getElementById('mensaje-ia').innerHTML = 
                        `<strong>üéì TUTOR IA - FASE 3:</strong><br>` +
                        `<span class='mensaje-error'>‚ùå Revisa el concepto</span><br>` +
                        `${mensajeIA}`;
                }
                
                enviarLog('Validar conexi√≥n', objeto.nombre, opcion, correcto, puntosGanados, {
                    tiempoMs: tiemposPorFase[2]
                });
                
            } else if (correcto && !fase3Avanzada) {
                guardarTiempoFase(2);
                respuestasUsuario[indexFase3].opcion = opcion;
                respuestasUsuario[indexFase3].correcto = correcto;
                respuestasUsuario[indexFase3].retroalimentacion = mensajeIA;
                respuestasUsuario[indexFase3].tiempo = tiemposPorFase[2];
                
                document.getElementById('mensaje-ia').innerHTML = 
                    `<strong>üéì TUTOR IA - FASE 3:</strong><br>` +
                    `<span class='mensaje-exito'>‚úÖ ¬°Ahora es correcto!</span><br>` +
                    `${mensajeIA}<br><br>` +
                    `‚è±Ô∏è Generando an√°lisis final...`;
                
                fase3Avanzada = true;
                setTimeout(() => mostrarResultados(), 12000);
                
                enviarLog('Validar conexi√≥n (corregido)', objeto.nombre, opcion, correcto, 30, {
                    tiempoMs: tiemposPorFase[2]
                });
            }
        }

        // ============================================
        // MOSTRAR RESULTADOS
        // ============================================
        async function mostrarResultados() {
            if (tiempoInicioFase) {
                guardarTiempoFase(faseActual);
            }
            
            document.getElementById('barra-superior').classList.add('oculto');
            document.getElementById('panel-ia').classList.remove('oculto');
            document.getElementById('indicador-ar').classList.add('oculto');
            document.getElementById('contenedor-ar').classList.add('oculto');
            document.getElementById('escena-vr').classList.add('oculto');
            document.getElementById('qr-visualizacion').style.display = 'none';
            document.getElementById('distancia-info').classList.add('oculto');
            
            if (botonVR) botonVR.remove();
            
            document.getElementById('puntaje-final').textContent = puntaje;
            
            document.getElementById('mensaje-ia').innerHTML = 
                `<strong>üéì TUTOR IA:</strong><br>` +
                `Generando an√°lisis personalizado para la sesi√≥n #${numeroSesion}...`;
            
            const mensajeRecomendaciones = await generarRespuestaUnica({
                tipo: 'recomendaciones'
            });
            
            generarRecomendaciones(mensajeRecomendaciones);
            
            document.getElementById('resultados').style.display = 'flex';
            
            const tiempoTotal = tiemposPorFase[0] + tiemposPorFase[1] + tiemposPorFase[2];
            enviarLog('Actividad completada', 'general', null, null, puntaje, {
                respuestas: respuestasUsuario,
                tiemposPorFase: tiemposPorFase,
                tiempoTotalMs: tiempoTotal,
                sesion: numeroSesion
            });
        }

        function generarRecomendaciones(mensajeIA) {
            const contenedor = document.getElementById('recomendaciones-container');
            
            const puntajeMaximo = 100;
            const porcentaje = (puntaje / puntajeMaximo) * 100;
            
            let nivel = '';
            if (porcentaje >= 90) nivel = 'üèõÔ∏è Arquitecto Experto';
            else if (porcentaje >= 70) nivel = 'üìê Dise√±ador Competente';
            else if (porcentaje >= 50) nivel = 'üìè Aprendiz en Desarrollo';
            else nivel = 'üéì Estudiante Principiante';
            
            let recomendacionesHTML = '<h3 style="color: #00BCD4; text-align: center; margin-bottom: 20px;">üìà AN√ÅLISIS DEL TUTOR IA</h3>';
            
            recomendacionesHTML += `<div style="text-align: right; font-size: 10px; color: #87CEEB; margin-bottom: 10px;">`;
            recomendacionesHTML += `üÜî Sesi√≥n #${numeroSesion} | ${new Date().toLocaleString()}`;
            recomendacionesHTML += `</div>`;
            
            recomendacionesHTML += '<div style="margin: 15px 0; padding: 15px; background: rgba(255, 255, 255, 0.05); border-radius: 10px;">';
            recomendacionesHTML += '<p><strong style="color: #00BCD4;">Tiempos por fase:</strong></p>';
            recomendacionesHTML += `<p>‚è±Ô∏è Fase 1 (${objetoFase1?.nombre || 'Objeto'}): ${(tiemposPorFase[0] / 1000).toFixed(2)} segundos</p>`;
            recomendacionesHTML += `<p>‚è±Ô∏è Fase 2 (${objetoFase2?.nombre || 'Objeto'}): ${(tiemposPorFase[1] / 1000).toFixed(2)} segundos</p>`;
            recomendacionesHTML += `<p>‚è±Ô∏è Fase 3 (${objetoFase3?.nombre || 'Objeto'}): ${(tiemposPorFase[2] / 1000).toFixed(2)} segundos</p>`;
            recomendacionesHTML += `<p>‚è±Ô∏è Tiempo total: ${((tiemposPorFase[0] + tiemposPorFase[1] + tiemposPorFase[2]) / 1000).toFixed(2)} segundos</p>`;
            recomendacionesHTML += '</div>';
            
            recomendacionesHTML += '<div style="margin: 15px 0; padding: 15px; background: rgba(255, 255, 255, 0.05); border-radius: 10px;">';
            recomendacionesHTML += `<p><strong style="color: #00BCD4;">Nivel alcanzado:</strong> ${nivel}</p>`;
            recomendacionesHTML += `<p><strong style="color: #00BCD4;">Puntaje:</strong> ${puntaje}/${puntajeMaximo} (${porcentaje.toFixed(1)}%)</p>`;
            recomendacionesHTML += '</div>';
            
            recomendacionesHTML += '<div style="margin: 15px 0; padding: 20px; background: rgba(0, 188, 212, 0.1); border-radius: 10px; border-left: 5px solid #00BCD4;">';
            recomendacionesHTML += `<p style="white-space: pre-line; line-height: 1.8;">üéì <strong>Recomendaciones de tu tutor IA:</strong><br><br>${mensajeIA}</p>`;
            recomendacionesHTML += '</div>';
            
            contenedor.innerHTML = recomendacionesHTML;
        }

        // ============================================
        // EXPORTAR FUNCIONES AL √ÅMBITO GLOBAL
        // ============================================
        window.mostrarConceptualizacion = mostrarConceptualizacion;
        window.volverInicio = volverInicio;
        window.comenzarActividad = comenzarActividad;
        window.reiniciar = reiniciar;
        window.validarVistaFrontal = validarVistaFrontal;

        // Precargar QR
        setTimeout(() => {
            const canvas = document.getElementById('qr-canvas');
            if (canvas) {
                QRCode.toCanvas(canvas, 'ARQUITECTO', { width: 200, margin: 2 }, (error) => {
                    if (error) console.error('Error precargando QR:', error);
                });
            }
        }, 1000);

        enviarLog('P√°gina cargada');
    </script>
</body>
</html>
